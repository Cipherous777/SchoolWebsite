<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IIS Portal â€¢ Teacher Login</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/CSS/main.css" />
  <link rel="stylesheet" href="/CSS/register.css" />
  <link rel="stylesheet" href="/CSS/formStyle.css" />
  
  <style>
    .code-digit { width: 48px; height: 48px; font-size: 24px; text-align: center; border: 2px solid #ddd; border-radius: 8px; }
    .code-digit:focus { border-color: #9f7aea; box-shadow: 0 0 10px rgba(159,122,234,0.4); outline: none; }
    .code-boxes { display: flex; gap: 12px; justify-content: center; margin: 20px 0; }
    .error-message { color: #e53e3e; font-size: 14px; margin-top: 10px; display: none; }
    .success-message { color: #38a169; font-size: 16px; font-weight: bold; margin-top: 10px; display: none; }
    .name-display { 
      font-size: 22px; 
      font-weight: bold; 
      padding: 16px; 
      background: #f3e8ff; 
      border-radius: 10px; 
      text-align: center;
      transition: all 0.4s;
      min-height: 70px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #6b46c1;
    }
    .loading { opacity: 0.6; pointer-events: none; }
  </style>
</head>
<body>
  <header class="portal-header">
    <a href="/" style="text-decoration: none">
      <div class="logo">
        <img src="/images/portal-logo.png" alt="IIS Portal Logo" />
        <h1>IIS Portal</h1>
      </div>
    </a>
    <button class="signup-btn" onclick="history.back()">Back</button>
  </header>

  <main>
    <section class="role-selection">
      <div class="container">
        <h2 class="form-title">Teacher Login</h2>

        <div class="form">
          <form id="teacherLoginForm">
            <div id="rows">
              <div class="column" style="width: 100%; max-width: 500px; margin: 0 auto;">

                <div class="input">
                  <label>Teacher Name</label>
                  <div class="name-display" id="teacherNameDisplay">
                    Enter your 4-digit code to continue
                  </div>
                </div>

                <div style="text-align: center;">
                  <label style="font-size: 18px; margin-bottom: 10px; display: block;">Teacher Code</label>
                  <div class="code-boxes">
                    <input type="text" maxlength="1" class="code-digit" required />
                    <input type="text" maxlength="1" class="code-digit" required />
                    <input type="text" maxlength="1" class="code-digit" required />
                    <input type="text" maxlength="1" class="code-digit" required />
                  </div>

                  <div class="error-message" id="errorMessage"></div>
                  <div class="success-message" id="successMessage"></div>
                </div>

                <div class="button" style="margin-top: 30px; justify-content: center;">
                  <button type="button" onclick="history.back()" class="btn-prev">Back</button>
                  <button type="submit" id="submitBtn" disabled>Enter Teacher Portal</button>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </section>
  </main>

  <script>
    const codeDigits = document.querySelectorAll('.code-digit');
    let currentTeacher = null;

    codeDigits.forEach((input, i, arr) => {
      input.addEventListener('input', (e) => {
        e.target.value = e.target.value.replace(/[^0-9]/g, '');
        if (e.target.value && i < 3) arr[i + 1].focus();
        if (getCode().length === 4) verifyTeacher();
      });
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && !e.target.value && i > 0) arr[i - 1].focus();
      });
    });

    function getCode() {
      return Array.from(codeDigits).map(i => i.value).join('');
    }

    async function verifyTeacher() {
      const code = getCode();
      if (code.length !== 4) return;

      setLoading(true);
      hideMessages();

      try {
        const res = await fetch('/signin.teacher', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: `code=${code}`
        });

        const data = await res.json();

        if (data.success) {
          currentTeacher = data;
          document.getElementById('teacherNameDisplay').innerHTML = `
            <div>
              <div style="font-size:26px;color:#7c3aed;">${data.name}</div>
              <div style="font-weight:500;color:#805ad5;">${data.subject} Teacher</div>
            </div>
          `;
          document.getElementById('teacherNameDisplay').style.background = '#e9d8fd';
          showSuccess(`Welcome back, ${data.name}!`);
          document.getElementById('submitBtn').disabled = false;
        } else {
          showError(data.error || "Invalid teacher code");
          resetForm();
        }
      } catch (err) {
        showError("Connection failed. Is the server running?");
        resetForm();
      } finally {
        setLoading(false);
      }
    }

    document.getElementById('teacherLoginForm').addEventListener('submit', (e) => {
      e.preventDefault();
      if (!currentTeacher) return showError("Please verify first");

      window.location.href = `/portal.teacher?name=${encodeURIComponent(currentTeacher.name)}&subject=${encodeURIComponent(currentTeacher.subject)}&grades=${currentTeacher.grades.join(',')}&code=${currentTeacher.code}`;
    });

    function showError(msg) {
      document.getElementById('errorMessage').textContent = msg;
      document.getElementById('errorMessage').style.display = 'block';
      document.getElementById('successMessage').style.display = 'none';
    }
    function showSuccess(msg) {
      document.getElementById('successMessage').textContent = msg;
      document.getElementById('successMessage').style.display = 'block';
      document.getElementById('errorMessage').style.display = 'none';
    }
    function hideMessages() {
      document.getElementById('errorMessage').style.display = 'none';
      document.getElementById('successMessage').style.display = 'none';
    }
    function setLoading(yes) {
      const btn = document.getElementById('submitBtn');
      btn.textContent = yes ? 'Verifying...' : 'Enter Teacher Portal';
      btn.disabled = yes;
      btn.classList.toggle('loading', yes);
    }
    function resetForm() {
      document.getElementById('teacherNameDisplay').textContent = 'Enter your 4-digit code to continue';
      document.getElementById('teacherNameDisplay').style.background = '#f3e8ff';
      document.getElementById('submitBtn').disabled = true;
      currentTeacher = null;
    }

    // Auto-clear if user changes code
    codeDigits.forEach(el => el.addEventListener('input', () => {
      if (getCode().length < 4) resetForm();
    }));
  </script>
</body>
</html>